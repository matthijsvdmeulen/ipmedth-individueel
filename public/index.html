<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Space Usabilityonderzoek</title>

    <script>
      // Application Vars

      // DB naam
      const db = "v1";

      // Firebase realtime database URL
      const dburl = "https://ipmedth-individueel-default-rtdb.europe-west1.firebasedatabase.app/";

      // Firebase storage URL
      const storageurl = "gs://ipmedth-individueel.appspot.com/";

      // URL onderzoeken
      const onderzoeken = {
        "v1": "",
        "v2": "",
        "v3": "",
        "v4": "",
        "v5": "",
        "v6": "",
        "v7": "",
        "v8": "",
      }
    </script>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/8.3.1/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/8.3.1/firebase-database.js"></script>
    <script defer src="/__/firebase/8.3.1/firebase-storage.js"></script>

    <style media="screen">
      body { background: #ECEFF1; color: rgba(0,0,0,0.87); font-family: Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; }
      #message { background: white; max-width: 360px; margin: 100px auto 16px; padding: 32px 24px; border-radius: 3px;}
      #message h2 { color: #ffa100; font-weight: bold; font-size: 16px; margin: 0 0 8px; }
      #message h1 { font-size: 22px; font-weight: 300; color: rgba(0,0,0,0.6); margin: 0 0 16px;}
      #message p { line-height: 140%; margin: 16px 0 24px; font-size: 14px; }
      #message a, input[type=submit] { display: block; text-align: center; background: #039be5; text-transform: uppercase; text-decoration: none; color: white; padding: 16px; border-radius: 4px; margin-top: 16px; border: none; box-sizing: border-box; width: 100%}
      #message input:focus { border: none; outline: none;}
      #message .proto { display: none; }
      #message .abs {position: relative; margin-top: 16px;}
      #message label {display: block; position: absolute; top: -8px; left: 16px; background-color: white; padding: 0 8px;}
      #message input[type=text], #message #filediv {display: block; padding: 10px; border: 2px solid black; border-radius: 4px; width: 100%; box-sizing: border-box;}
      #message input[type=file] {display: block; width: 100%;}
      #message, #message a { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
      #load { color: rgba(0,0,0,0.4); text-align: center; font-size: 13px; }
      @media (max-width: 600px) {
        body, #message { margin-top: 0; background: white; box-shadow: none; }
        body { border-top: 16px solid #ffa100; }
      }
    </style>
  </head>
  <body>
    <div id="message">
      <h2>Welkom!</h2>
      <h1>The Space usabilityonderzoek</h1>
      <p class="proto">Om te zorgen voor goede feedback schotelen we iedereen 2 willekeurige versies van het prototype voor, de versies die voor jouw geselecteerd zijn vind je hieronder (ze openen in een nieuw tabblad)</p>
      <a target="_blank" class="proto" id="proto1" href="https://firebase.google.com/docs/hosting/">Open eerste prototype</a>
      <a target="_blank" class="proto" id="proto2" href="https://firebase.google.com/docs/hosting/">Open tweede prototype</a>
      <p class="form">Wij zijn door school verplicht om van al onze testpersonen een foto met de testopstelling aan te leveren samen met de naam van de testpersoon. Maak dus alsjeblieft een foto of selfie met deze pagina, en upload die hieronder. Deze gegevens worden strikt vertrouwelijk behandeld en worden alleen aan de examinatoren van ons onderzoek doorgestuurd</p>
      <form class="form">
        <div class="abs">
          <label for="naam" id="naamlabel">Naam</label>
          <input type="text" name="naam" id="naam">
        </div>
        <div class="abs">
          <label for="file" id="filelabel">Bestand</label>
          <div id="filediv">
            <input type="file" name="file" id="file">
          </div>
        </div>

        <input type="submit" id="submit" value="Verzenden" />
      </form>
    </div>
    <p id="load">Firebase SDK Loading&hellip;</p>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const loadEl = document.querySelector('#load');
        const values = document.querySelector('#values');
        const submit = document.querySelector('#submit');
        const naamlabel = document.querySelector('#naamlabel');
        const naam = document.querySelector('#naam');
        const file = document.querySelector('#file');
        const filelabel = document.querySelector('#filelabel');
        const filediv = document.querySelector('#filediv');

        firebase.initializeApp({
          databaseURL: dburl,
          storageBucket: storageurl
        });

        try {
          let app = firebase.app();
          let features = [
            'database',
            'storage',
          ].filter(feature => typeof app[feature] === 'function');
          loadEl.textContent = `Firebase SDK loaded with ${features.join(', ')}`;
        } catch (e) {
          console.error(e);
          loadEl.textContent = 'Error loading the Firebase SDK, check the console.';
        }

        var storage = firebase.storage().ref();

        submit.addEventListener('click', event => {
          event.preventDefault();
          if (naam.value === "") {
            naam.style.border = "2px solid red";
            naamlabel.style.color = "red";
            file.color = "red";
          } else {
            naam.style.border = "2px solid green";
            naamlabel.style.color = "green";
            file.color = "green";
          }
          if (file.value === "") {
            filediv.style.border = "2px solid red";
            filelabel.style.color = "red";
          } else {
            filediv.style.border = "2px solid green";
            filelabel.style.color = "green";
          }

          if(naam.value !== "" && file.value !== "") {
            bestandCloud = storage.child(naam.value);
            bestandLokaal = file.files[0];
            bestandCloud.put(bestandLokaal).then(snapshot => {
              console.log('geupload!');
            });

            proto1 = document.querySelector('#proto1');
            proto2 = document.querySelector('#proto2');

            firebase.database().ref(db).once('value', snapshot => {
              proto1data = Object.entries(snapshot.val().proto1);
              proto1data.sort((val1, val2) => {
                return val1[1] - val2[1];
              });
              proto1data.pop();
              finalproto1 = proto1data[Math.floor(Math.random() * Math.floor(proto1data.length))];

              proto2data = Object.entries(snapshot.val().proto2);
              proto2data.sort((val1, val2) => {
                return val1[1] - val2[1];
              });
              finalproto2 = proto2data[0];

              proto1.href = onderzoeken[finalproto1[0]];
              firebase.database().ref(db + "/proto1/" + finalproto1[0]).set(finalproto1[1] + 1);
              proto2.href = onderzoeken[finalproto2[0]];
              firebase.database().ref(db + "/proto2/" + finalproto2[0]).set(finalproto2[1] + 1);
            });

            document.querySelectorAll('.proto').forEach(element => {
              element.style.display = 'block';
            })
            document.querySelectorAll('.form').forEach(element => {
              element.style.display = 'none';
            })
          }

        });


      });
    </script>
  </body>
</html>
